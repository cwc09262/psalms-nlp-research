import pandas as pd
import random

INPUT_CSV = "full_results.csv"
OUTPUT_CSV = "results_scored.csv"

def load_data():
    # try loading the scored file first
    try:
        df = pd.read_csv(OUTPUT_CSV)
        print(f"Loaded existing scored file: {OUTPUT_CSV}")
        return df
    except FileNotFoundError:
        pass

    # otherwise load the original input
    try:
        df = pd.read_csv(INPUT_CSV)
        print(f"Loaded input CSV: {INPUT_CSV}")
    except FileNotFoundError:
        print("Could not find input CSV:", INPUT_CSV)
        exit()

    # add HumanScore column if missing
    if "HumanScore" not in df.columns:
        df["HumanScore"] = pd.NA

    return df

def save_data(df):
    df.to_csv(OUTPUT_CSV, index=False)
    print(f"Progress saved to {OUTPUT_CSV}")

def get_unscored_index(df):
    df_unscored = df[df["HumanScore"].isna()]
    if df_unscored.empty:
        return None, 0
    return random.choice(df_unscored.index.tolist()), len(df_unscored)

def show_row(df, idx, remaining, percent):
    row = df.loc[idx]
    print("\n======================================")
    print(f"UNSCORED PSALMS LEFT: {remaining}, ({percent}%)")
    print("QUERY:")
    print(row["Query"])
    print("\nRESULT:")
    print(row["Verse"])
    print(f"\nPsalm: {row['Psalm Num']}")
    print("======================================")
    print("Rate this result 0â€“10 (or 'q' to quit)")

def get_score():
    while True:
        x = input("Score: ").strip()
        if x.lower() == "q":
            return None
        if x.isdigit() and 0 <= int(x) <= 10:
            return int(x)
        print("Invalid input â€” enter a number 0â€“10 or 'q' to quit.")

def main():
    df = load_data()
    print("\nReady to evaluate!")
    print("Press 'q' to quit at any time.\n")

    while True:
        idx, remaining = get_unscored_index(df)
        if idx is None:
            print("\nAll rows have been scored. ðŸŽ‰")
            save_data(df)
            break

        show_row(df, idx, remaining, remaining/len(df))
        score = get_score()

        if score is None:
            print("\nQuitting. Saving progressâ€¦")
            save_data(df)
            break

        df.at[idx, "HumanScore"] = score
        save_data(df)

if __name__ == "__main__":
    main()
